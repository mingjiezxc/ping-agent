# ping-agent

## redis key

```bash
agents

$ageent_online

// ping is err list 表, 定时检查 ip 时间段内是否有丢包，如无则移出。
$agent_err_ip_list, set
["xx", "xx",  "xx"]

// cron job list 名称
$agent_job_list, set 
{SPEC:"* * * * *" , name:"xxxx"}

// cron job data
$agent_$jobName, key
{SPEC:"* * * * *" , IP:["xx","xx"]}

// ip 状态最新, agent 监听 timeout 事件，如发生将 ip ，添加至 err list
$agent_$ip,  list set timeout
[ ms, ms, ms ]

// agent 在线状态
$agent_online, key set timeout
"online"
```


## agent Listen ICMP package
[![](https://mermaid.ink/img/eyJjb2RlIjoiZ3JhcGggVERcbiAgICBBW0xpc3RlbiBJQ01QIFNlcnZlcl0gLS0-fGdldCBpY21wIHBhY2thZ2V8IEIocmVhZCBwYWNrYWdlIGpvYilcbiAgICBCIC0tPnxtZW1vcnkgbWFwfCBGW2dldCBpcCB0dGxdXG4gICAgQiAtLT58aXAgaGVhZHwgRFtzcmMgaXBdXG4gICAgQiAtLT58cGFja2FnZSBib2R5fCBFW1VuaXggdGltZXN0YW1wXVxuICAgIEQgLS0-fHJlZGlzIGtleXwgR1tyZWRpcy1zZXJ2ZXJdXG4gICAgRSAtLT58cmVkaXMgdmFyfCBHXG4gICAgRiAtLT58cmVkaXMgdHRsfCBHIiwibWVybWFpZCI6eyJ0aGVtZSI6ImRlZmF1bHQifSwidXBkYXRlRWRpdG9yIjpmYWxzZSwiYXV0b1N5bmMiOnRydWUsInVwZGF0ZURpYWdyYW0iOmZhbHNlfQ)](https://mermaid-js.github.io/mermaid-live-editor/edit/###eyJjb2RlIjoiZ3JhcGggVERcbiAgICBBW0VyciBJUCBMaXN0IEpvYiBdIC0tPiBCKENyZWF0ZSBJQ01QIFBhY2thZ2UpXG4gICAgQ1tkZWZpbml0ZSB0aW1lIElQIExpc3QgSm9iIDEwcyBdIC0tPiBCKENyZWF0ZSBJQ01QIFBhY2thZ2UpXG4gICAgRFtkZWZpbml0ZSB0aW1lIElQIExpc3QgSm9iIDYwcyBdIC0tPiBCKENyZWF0ZSBJQ01QIFBhY2thZ2UpXG4gICAgQiAtLT4gfGJvZHkgdW5pbnggdGltZXN0YW1wfEVbSUNNUCBQYWNrYWdlXVxuICAgIEUgLS0-IEZbYV1cblxuICAiLCJtZXJtYWlkIjoie1xuICBcInRoZW1lXCI6IFwiZGVmYXVsdFwiXG59IiwidXBkYXRlRWRpdG9yIjpmYWxzZSwiYXV0b1N5bmMiOnRydWUsInVwZGF0ZURpYWdyYW0iOmZhbHNlfQ)

## agent jobs
[![](https://mermaid.ink/img/eyJjb2RlIjoiZ3JhcGggVERcbiAgICBBW0VyciBJUCBMaXN0IEpvYiBdIC0tPiBCKENyZWF0ZSBJQ01QIFBhY2thZ2UpXG4gICAgQ1tkZWZpbml0ZSB0aW1lIElQIExpc3QgSm9iIDEwcyBdIC0tPiBCKENyZWF0ZSBJQ01QIFBhY2thZ2UpXG4gICAgRFtkZWZpbml0ZSB0aW1lIElQIExpc3QgSm9iIDYwcyBdIC0tPiBCKENyZWF0ZSBJQ01QIFBhY2thZ2UpXG4gICAgQiAtLT4gfGJvZHkgdW5pbnggdGltZXN0YW1wfEVbSUNNUCBQYWNrYWdlXVxuICAgIEUgLS0-IHxzZW5kfEZbVHJhZ2VudCBJUF1cblxuICAiLCJtZXJtYWlkIjp7InRoZW1lIjoiZGVmYXVsdCJ9LCJ1cGRhdGVFZGl0b3IiOmZhbHNlLCJhdXRvU3luYyI6dHJ1ZSwidXBkYXRlRGlhZ3JhbSI6ZmFsc2V9)](https://mermaid-js.github.io/mermaid-live-editor/edit/##eyJjb2RlIjoiZ3JhcGggVERcbiAgICBBW0VyciBJUCBMaXN0IEpvYiBdIC0tPiBCKENyZWF0ZSBJQ01QIFBhY2thZ2UpXG4gICAgQ1tkZWZpbml0ZSB0aW1lIElQIExpc3QgSm9iIDEwcyBdIC0tPiBCKENyZWF0ZSBJQ01QIFBhY2thZ2UpXG4gICAgRFtkZWZpbml0ZSB0aW1lIElQIExpc3QgSm9iIDYwcyBdIC0tPiBCKENyZWF0ZSBJQ01QIFBhY2thZ2UpXG4gICAgQiAtLT4gfGJvZHkgdW5pbnggdGltZXN0YW1wfEVbSUNNUCBQYWNrYWdlXVxuICAgIEUgLS0-IHxzZW5kfCBGW1RyYWdlbnQgSVBdXG5cbiAgIiwibWVybWFpZCI6IntcbiAgXCJ0aGVtZVwiOiBcImRlZmF1bHRcIlxufSIsInVwZGF0ZUVkaXRvciI6ZmFsc2UsImF1dG9TeW5jIjp0cnVlLCJ1cGRhdGVEaWFncmFtIjpmYWxzZX0)


## update err IP list
[![](https://mermaid.ink/img/eyJjb2RlIjoiZ3JhcGggVERcbiAgICBBW0xpc3RlbiBJQ01QIFNlcnZlcl0gLS0-fGdldCBpY21wIHBhY2thZ2V8IEIocmVhZCBwYWNrYWdlIGpvYilcbiAgICBCIC0tPnxtZW1vcnkgbWFwfCBGW2dldCBpcCB0dGxdXG4gICAgQiAtLT58aXAgaGVhZHwgRFtzcmMgaXBdXG4gICAgQiAtLT58cGFja2FnZSBib2R5fCBFW1VuaXggdGltZXN0YW1wXVxuICAgIEQgLS0-fHJlZGlzIGtleXwgR1tyZWRpcy1zZXJ2ZXJdXG4gICAgRSAtLT58cmVkaXMgdmFyfCBHXG4gICAgRiAtLT58cmVkaXMgdHRsfCBHIiwibWVybWFpZCI6eyJ0aGVtZSI6ImRlZmF1bHQifSwidXBkYXRlRWRpdG9yIjpmYWxzZSwiYXV0b1N5bmMiOnRydWUsInVwZGF0ZURpYWdyYW0iOmZhbHNlfQ)](https://mermaid-js.github.io/mermaid-live-editor/edit/###eyJjb2RlIjoiZ3JhcGggVERcbiAgICBBW0VyciBJUCBMaXN0IEpvYiBdIC0tPiBCKENyZWF0ZSBJQ01QIFBhY2thZ2UpXG4gICAgQ1tkZWZpbml0ZSB0aW1lIElQIExpc3QgSm9iIDEwcyBdIC0tPiBCKENyZWF0ZSBJQ01QIFBhY2thZ2UpXG4gICAgRFtkZWZpbml0ZSB0aW1lIElQIExpc3QgSm9iIDYwcyBdIC0tPiBCKENyZWF0ZSBJQ01QIFBhY2thZ2UpXG4gICAgQiAtLT4gfGJvZHkgdW5pbnggdGltZXN0YW1wfEVbSUNNUCBQYWNrYWdlXVxuICAgIEUgLS0-IEZbYV1cblxuICAiLCJtZXJtYWlkIjoie1xuICBcInRoZW1lXCI6IFwiZGVmYXVsdFwiXG59IiwidXBkYXRlRWRpdG9yIjpmYWxzZSwiYXV0b1N5bmMiOnRydWUsInVwZGF0ZURpYWdyYW0iOmZhbHNlfQ)